{% extends 'base.html' %}

{% block title %}{{ room.name }} - Private Chat{% endblock %}

{% block content %}
<div class="row h-100">
    <div class="col-12">
        <!-- Chat Header -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">
                            {% if room.room_type == 'private' %}
                                <i class="bi bi-person-circle"></i>
                            {% else %}
                                <i class="bi bi-people-fill"></i>
                            {% endif %}
                            {{ room.name }}
                        </h4>
                        <small class="text-muted">
                            {% for participant in other_participants %}
                                {{ participant.username }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                    </div>
                    <a href="{% url 'chat:chat_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Chats
                    </a>
                </div>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div id="chat-messages" class="chat-messages-container p-3" style="height: 500px; overflow-y: auto;">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="message mb-3 {% if message.sender == user %}text-end{% endif %}">
                                <div class="d-inline-block {% if message.sender == user %}bg-primary text-white{% else %}bg-light{% endif %} rounded p-3 message-bubble">
                                    <strong>{{ message.sender.username }}</strong>
                                    
                                    {% if message.message_type == 'image' %}
                                        <div class="mt-2">
                                            <img src="{{ message.file.url }}" alt="{{ message.file_name }}" 
                                                 style="max-width: 300px; max-height: 300px; border-radius: 8px; cursor: pointer;"
                                                 onclick="window.open('{{ message.file.url }}', '_blank')">
                                        </div>
                                    {% elif message.message_type == 'video' %}
                                        <div class="mt-2">
                                            <video controls style="max-width: 300px; border-radius: 8px;">
                                                <source src="{{ message.file.url }}" type="video/mp4">
                                            </video>
                                        </div>
                                    {% elif message.message_type == 'audio' %}
                                        <div class="mt-2">
                                            <audio controls style="max-width: 300px;">
                                                <source src="{{ message.file.url }}" type="audio/mpeg">
                                            </audio>
                                        </div>
                                    {% elif message.message_type == 'file' %}
                                        <div class="mt-2">
                                            <a href="{{ message.file.url }}" download="{{ message.file_name }}" 
                                               class="text-decoration-none {% if message.sender == user %}text-white{% else %}text-primary{% endif %}">
                                                <i class="bi bi-file-earmark-arrow-down"></i> {{ message.file_name }}
                                                <br><small>({{ message.get_file_size_display }})</small>
                                            </a>
                                        </div>
                                    {% else %}
                                        <p class="mb-1">{{ message.encrypted_content }}</p>
                                    {% endif %}
                                    
                                    <small class="{% if message.sender == user %}text-white-50{% else %}text-muted{% endif %} d-block mt-1">{{ message.timestamp|date:"H:i" }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-chat-quote" style="font-size: 3rem;"></i>
                            <p class="mt-3">No messages yet. Start the conversation!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Message Input Form -->
            <div class="card-footer bg-light">
                <form id="message-form" class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="emoji-btn" title="Insert emoji">
                        😊
                    </button>
                    <input type="text" 
                           id="message-input" 
                           class="form-control" 
                           placeholder="Type your message..." 
                           autocomplete="off"
                           required>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send-fill"></i>
                    </button>
                    <button type="button" class="btn btn-secondary" id="attach-file">
                        <i class="bi bi-paperclip"></i>
                    </button>
                </form>
                <input type="file" id="file-input" style="display: none;">
            </div>
        </div>
    </div>
</div>

<style>
.chat-messages-container {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.message-bubble {
    max-width: 70%;
    word-wrap: break-word;
}

.message-bubble p {
    margin-bottom: 0.25rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    const roomId = {{ room.id }};
    const currentUser = "{{ user.username }}";
    const currentUserId = {{ user.id }};
    
    // Establish WebSocket connection
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = protocol + '//' + window.location.host + '/ws/chat/' + roomId + '/';
    
    console.log('Connecting to WebSocket:', wsUrl);
    const chatSocket = new WebSocket(wsUrl);
    
    // WebSocket event handlers
    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established');
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('Message received:', data);
        
        if (data.type === 'connection') {
            console.log(data.message);
        } else if (data.type === 'message') {
            displayMessage(data);
        }
    };
    
    chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
    
    chatSocket.onclose = function(e) {
        console.log('WebSocket closed:', e.code);
        if (e.code !== 1000) {
            alert('Connection lost. Please refresh the page.');
        }
    };
    
    // Display incoming message
    function displayMessage(data) {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        const isCurrentUser = data.sender_id === currentUserId;
        
        messageDiv.className = 'message mb-3 ' + (isCurrentUser ? 'text-end' : '');
        
        const bubbleClass = isCurrentUser ? 'bg-primary text-white' : 'bg-light';
        const timeClass = isCurrentUser ? 'text-white-50' : 'text-muted';
        
        let messageContent = '';
        
        // Handle different message types
        if (data.message_type === 'text') {
            messageContent = `
                <strong>${escapeHtml(data.sender)}</strong>
                <p class="mb-1">${escapeHtml(data.message)}</p>
                <small class="${timeClass} d-block">${formatTime(data.timestamp)}</small>
            `;
        } else if (data.message_type === 'image') {
            messageContent = `
                <strong>${escapeHtml(data.sender)}</strong>
                <div class="mt-2">
                    <img src="${data.file_url}" alt="${escapeHtml(data.file_name)}" 
                         style="max-width: 300px; max-height: 300px; border-radius: 8px; cursor: pointer;"
                         onclick="window.open('${data.file_url}', '_blank')">
                </div>
                <small class="${timeClass} d-block mt-1">${formatTime(data.timestamp)}</small>
            `;
        } else if (data.message_type === 'video') {
            messageContent = `
                <strong>${escapeHtml(data.sender)}</strong>
                <div class="mt-2">
                    <video controls style="max-width: 300px; border-radius: 8px;">
                        <source src="${data.file_url}" type="video/mp4">
                    </video>
                </div>
                <small class="${timeClass} d-block mt-1">${formatTime(data.timestamp)}</small>
            `;
        } else if (data.message_type === 'audio') {
            messageContent = `
                <strong>${escapeHtml(data.sender)}</strong>
                <div class="mt-2">
                    <audio controls style="max-width: 300px;">
                        <source src="${data.file_url}" type="audio/mpeg">
                    </audio>
                </div>
                <small class="${timeClass} d-block mt-1">${formatTime(data.timestamp)}</small>
            `;
        } else if (data.message_type === 'file') {
            const fileSize = formatFileSize(data.file_size);
            messageContent = `
                <strong>${escapeHtml(data.sender)}</strong>
                <div class="mt-2">
                    <a href="${data.file_url}" download="${escapeHtml(data.file_name)}" 
                       class="text-decoration-none ${isCurrentUser ? 'text-white' : 'text-primary'}">
                        <i class="bi bi-file-earmark-arrow-down"></i> ${escapeHtml(data.file_name)}
                        <br><small>(${fileSize})</small>
                    </a>
                </div>
                <small class="${timeClass} d-block mt-1">${formatTime(data.timestamp)}</small>
            `;
        }
        
        messageDiv.innerHTML = '<div class="d-inline-block ' + bubbleClass + ' rounded p-3 message-bubble">' + messageContent + '</div>';
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Send message
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        
        if (message && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'text',
                'message': message
            }));
            messageInput.value = '';
        } else if (chatSocket.readyState !== WebSocket.OPEN) {
            alert('Connection lost. Please refresh the page.');
        }
    });
    
    // Helper functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }
    
    function formatFileSize(bytes) {
        if (!bytes) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Auto-scroll to bottom
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // File upload
    document.getElementById('attach-file').addEventListener('click', function() {
        document.getElementById('file-input').click();
    });
    
    document.getElementById('file-input').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const messageInput = document.getElementById('message-input');
        messageInput.value = 'Uploading ' + file.name + '...';
        messageInput.disabled = true;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
            
            const response = await fetch(`/upload/${roomId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'type': 'file',
                    'message_id': data.message_id
                }));
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Upload failed. Please try again.');
        } finally {
            messageInput.value = '';
            messageInput.disabled = false;
            messageInput.focus();
            e.target.value = '';
        }
    });
    
    // Emoji picker
    document.getElementById('emoji-btn').addEventListener('click', function() {
        const input = document.getElementById('message-input');
        const emojis = ['😊', '😂', '🤣', '😍', '🥰', '😘', '😎', '🤔', '😢', '😭', '😡', '🤯', '👍', '👎', '👏', '🙏', '💪', '🎉', '🔥', '💯', '❤️', '💔', '💕', '💖', '✨', '⭐', '🌟', '💫', '🎈', '🎁'];
        const emojiSelection = prompt('Select emoji:\n\n' + emojis.join(' ') + '\n\nOr type your own:');
        if (emojiSelection) {
            input.value += emojiSelection;
            input.focus();
        }
    });
</script>
{% endblock %}
